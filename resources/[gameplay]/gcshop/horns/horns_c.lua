hornsTable = {
	[1] = "Birdo-geluidje",
	[2] = "Boo-gebulder",
	[3] = "Come on! - Wario",
	[4] = "Dry Bones-gegiechel",
	[5] = "Hatsjwao! Oh sorry.. - Luigi",
	[6] = "Hey Stinky! - Mario",
	[7] = "Mushroom! - Toadette",
	[8] = "Peach-annoy",
	[9] = "Toad-boeee",
	[10] = "Yoshi-cool geluid",
	[11] = "You know I'll win! - Daisy",
	[12] = "You're lousy! - Waluigi",
	[13] = "The Dukes of hazzard",
	[14] = "Adios",
	[15] = "Aww crap",
	[16] = "Bad Boys",
	[17] = "Beat it!",
	[18] = "Billnye",
	[19] = "Callonme",
	[20] = "Come out",
	[21] = "Dog",
	[22] = "English",
	[23] = "Feel good",
	[24] = "Haha",
	[25] = "Hello",
	[26] = "Madness",
	[27] = "Muh",
	[28] = "Muhaha",
	[29] = "Noobs",
	[30] = "Omg",
	[31] = "Sparta",
	[32] = "Suck",
	[33] = "Suckers",
	[34] = "Wazza",
	[35] = "Woohoo",
	[36] = "Yaba",
	[37] = "stewie",
	[38] = "titten",
	[39] = "buggle call",
	[40] = "random",
	[41] = "ring",
	[42] = "mario win",
	[43] = "goodbadugly",
	[44] = "who cares",
	[45] = "loser",
	[46] = "noooo",
	[47] = "cartman",
	[48] = "such a noob",
	[49] = "Noobs",
	[50] = "hello again",
	[51] = "haaaaaai",
	[52] = "knock knock",
	[53] = "giggity",
	[54] = "shade aran",
	[55] = "YES,YES.",
	[56] = "Burn baby burn.",
	[57] = "Cry some moar!",
	[58] = "Davaj do svidanija",
	[59] = "WHAT YOU GONNA DO",
	[60] = "Dr.Zaius",
	[61] = "Here we go",
	[62] = "Holy Shit",
	[63] = "It's my life",
	[64] = "JAAZZZZ",
	[65] = "Let's get ready to rumble",
	[66] = "What did you say nigga!?",
	[67] = "Not a big surprise",
	[68] = "Livin' on a prayer",
	[69] = "Low Rider",
	[70] = "MammaMia",
	[71] = "Mariodeath",
	[72] = "My horse is amazing",
	[73] = "U can't touch this",
	[74] = "We are the champions",
	[75] = "We will rock you",
	[76] = "Bye have a great time",
	[77] = "Damn son! Where'd you find this",
	[78] = "Denied!",
	[79] = "Derp!1!",
	[80] = "Fart SFX",
	[81] = "Fatality",
	[82] = "Finish him!",
	[83] = "Giggity",
	[84] = "Gotya bitch",
	[85] = "Headshot!",
	[86] = "Hehe! Alright",
	[87] = "Here We Go!",
	[88] = "Like A Baus",
	[89] = "Prepare to be astonished",
	[90] = "Smoke Weed Everyday",
	[91] = "Tah daah",
	[92] = "That's nasty",
	[93] = "Toasty!",
	[94] = "Whaaat",
	[95] = "You got knocked the fuck out",
	[96] = "You suck sound effect",
	[97] = "Haha You Suck",
	[98] = "Imma bust you up",
	[99] = "It's on, Baby",
	[100] = "Mess with the best",
	[101] = "That's gotta hurt",
	[102] = "Yo Whassup",
	[103] = "F--k you ceelo",
	[104] = "Stewie Mummy",
	[105] = "Hah, Ghaay",
	[106] = "J's on my feet",
	[107] = "Jim Carrey",
	[108] = "Minion laugh",
	[109] = "My nigga my nigga",
	[110] = "Darude - Sandstorm",
	[111] = "So it begins",
	[112] = "What are you doing",
	[113] = "Whoooaah",
	[114] = "Wiggle wiggle wiggle",
	[115] = "You shall not pass!",
	[116] = "Higher",
	[117] = "I need a dollar",
	[118] = "M-O Wall-E",
	[119] = "Wall-E",
	[120] = "Help!..nope",
	[121] = "I dare you",
	[122] = "Iragenerghvjksah",
	[123] = "KAR Spring Breeze",
	[124] = "Let's do this again",
	[125] = "Oh you",
	[126] = "Brush heavy's hair!",
	[127] = "OKTOBERFEST MAGGOT",
	[128] = "Full of SANDWITCHES!",
	[129] = "Scary",
	[130] = "Ugly, AAAH",
	[131] = "You're not a real soldier!",
	[132] = "1,2,3 Let's GO!",
	[133] = "Airporn",
	[134] = "Black & Yellow",
	[135] = "Don't look down",
	[136] = "Dreamscape",
	[137] = "GET NOSOCOPED!",
	[138] = "Oh baby a triple",
	[139] = "Put your hands up!!!",
	[140] = "Really, nigga?",
	[141] = "Schnappi",
	[142] = "Smoke Weed Everyday remix",
	[143] = "Spacemen",
	[144] = "They call it Merther!",
	[145] = "Sad violin air horn",
	[146] = "Fucking bi#@h!",
	[147] = "Nice and strong Cena",
	[148] = "Dikke BMW",
	[149] = "Burp!",
	[150] = "Meep-meep!",
	[151] = "Angels are crying",
	[152] = "Bocka bass",
	[153] = "I can't get no sleep",
	[154] = "Ja pierdole kurwa",
	[155] = "Komodo",
	[156] = "Let go",
	[157] = "Pop Hold it Down",
	[158] = "Sacrifice",
	[159] = "Single ladies",
	[160] = "Feel Good Drag",
	[161] = "They see me rollin",
	[162] = "OH. MY. GOD.",
}

function onShopInit ( tabPanel )
	shopTabPanel = tabPanel
	--triggerServerEvent('getHornsData', localPlayer)
	if isElement(hornsTab) then return end
	hornsTab = guiCreateTab("Custom Horns", shopTabPanel)
	gridList = guiCreateGridList(0.03, 0.45, 0.3, 0.5, true, hornsTab)
	guiGridListSetSortingEnabled(gridList, false)
	local column = guiGridListAddColumn(gridList, "Available horns", 0.9)
	for id, horn in ipairs(hornsTable) do 
		local row = guiGridListAddRow(gridList)
		guiGridListSetItemText(gridList, row, column, tostring(id)..") "..horn, false, false)
	end
	local label1 = guiCreateLabel(0.05, 0.04, 0.9, 0.15,"Welcome to Custom Horns. In this tab, you can listen to horns samples, buy horns and set your current one.",true,hornsTab)
	guiSetFont(label1, "default-bold-small")
	local label2 = guiCreateLabel(0.05, 0.09, 0.9, 0.15,"Please select an item below and click 'Play' or 'Buy'",true,hornsTab)
	local label3 = guiCreateLabel(0.05, 0.14, 0.9, 0.15,"Clicking 'play' will show you what it sounds like",true,hornsTab)
	local label4 = guiCreateLabel(0.05, 0.19, 0.9, 0.15,"Clicking 'buy' will add the horn to your list of bought horns for future usage",true,hornsTab)
	local label5 = guiCreateLabel(0.05, 0.24, 0.9, 0.15,"In the right box, you can choose from your bought horns which one to actually use as a horn with 'H'",true,hornsTab)
	label6 = guiCreateLabel(0.05, 0.29, 0.9, 0.15,"Current set horn can only be used 3 times per map (10 secs cool-off). Your current one is: none",true,hornsTab)
	local label8 = guiCreateLabel(0.05, 0.34, 0.9, 0.15,"However, you can buy unlimited usage of the custom horn for 5000 GC. This item applies to all horns.",true,hornsTab)
	local uses = guiCreateButton(0.05, 0.39, 0.15, 0.05, "Buy unlimited usage", true, hornsTab)
	addEventHandler ( "onClientGUIClick",uses, unlimitedHorn,false)
	local label7 = guiCreateLabel(0.35, 0.80, 0.60, 0.15,"Current price: 1500 GC (each)",true,hornsTab)
	local play = guiCreateButton(0.35, 0.47, 0.07, 0.05, "Play", true, hornsTab)
	addEventHandler ( "onClientGUIClick",play, playButton,false)
	addEventHandler ( "onClientGUIDoubleClick",gridList, playButton,false)
	local buy = guiCreateButton(0.35, 0.88, 0.07, 0.05, "Buy", true, hornsTab)
	addEventHandler ( "onClientGUIClick",buy, buyButton,false)
	ownList = guiCreateGridList(0.6, 0.45, 0.3, 0.5, true, hornsTab)
	addEventHandler ( "onClientGUIDoubleClick",ownList, setFunction,false)
	guiGridListSetSortingEnabled(ownList, false)
	ownColumn = guiGridListAddColumn(ownList, "My horns", 0.9)
	local setButton = guiCreateButton(0.91, 0.65, 0.07, 0.05, "Set", true, hornsTab)
	local disable = guiCreateButton(0.65, 0.39, 0.15, 0.05, "Disable my horn", true, hornsTab)
	addEventHandler ( "onClientGUIClick",disable, disableButton,false)
	addEventHandler ( "onClientGUIClick",setButton, setFunction,false)
end
addEvent('onShopInit', true)
addEventHandler('onShopInit', root, onShopInit )


function playButton(button, state)
	if button == "left" and state == "up" then	
		if isElement(soundTest) then
			stopSound(soundTest) 
		end
		local row, col = guiGridListGetSelectedItem(gridList)
		if row == -1 or row == false then
			return
		end
		row = row + 1

		soundTest = playSound("horns/files/"..tostring(row)..".mp3", false)
	end
end

function buyButton(button, state)
	if button == "left" and state == "up" then
		local row, col = guiGridListGetSelectedItem(gridList)
		if row == -1 or row == false then
			return
		end
		row = row + 1
		triggerServerEvent('onPlayerBuyHorn', localPlayer, row)
	end
end

function setFunction(button, state)
	if button == "left" and state == "up" then
		local row, col = guiGridListGetSelectedItem(ownList)
		if row == -1 or row == false then
			return
		end
		local soundName = guiGridListGetItemData(ownList, row, col)
		for i,j in ipairs(hornsTable) do 
			if j == soundName then
				triggerServerEvent('onPlayerSetHorn', localPlayer, i)
				break
			end	
		end
	end
end

function unlimitedHorn(button, state)
	if button == "left" and state == "up" then
		triggerServerEvent('onPlayerBuyUnlimitedHorn', localPlayer)
	end
end

function disableButton(button, state)
	if button == "left" and state == "up" then
		triggerServerEvent('onDisableHorn', localPlayer)
	end
end

addEvent('onClientSuccessBuyHorn', true)
addEventHandler('onClientSuccessBuyHorn', root,
function(success)
	if success then
		outputChatBox("Horn successfully bought")
		triggerServerEvent('getHornsData', localPlayer)
	else
		outputChatBox("Either not logged in, or not enough GC, or you already have this horn.")
	end
end
)

addEvent('onClientSuccessSetHorn', true)
addEventHandler('onClientSuccessSetHorn', root,
function(success)
	if success then
		outputChatBox("Horn successfully set as default horn")
		triggerServerEvent('getHornsData', localPlayer)
	else
		outputChatBox("Either not logged in, or you already have this horn.")
	end
end
)


addEvent("hornsLogin", true)
addEventHandler("hornsLogin", root,
function()
	triggerServerEvent('getHornsData', localPlayer)
end
)

addEvent("hornsLogout", true)
addEventHandler("hornsLogout", root,
function()
	--close the tab
	--[[if shopTabPanel and hornsTab then
		guiDeleteTab ( hornsTab, shopTabPanel )
		hornsTab = nil
	end]]
end
)

addEvent('sendHornsData', true)
addEventHandler('sendHornsData', root,
function(current, boughtHorns)
	guiGridListClear(ownList)
	if current == "none" then
		guiSetText(label6, "Current set horn can only be used 3 times per map (10 secs cool-off). Your current one is: "..current)
	else	
		guiSetText(label6, "Current set horn can only be used 3 times per map (10 secs cool-off). Your current one is: "..hornsTable[tonumber(current)])
	end	
	for i,j in ipairs(boughtHorns) do
		local row = guiGridListAddRow(ownList)
		guiGridListSetItemText(ownList, row, ownColumn, tostring(j)..") "..hornsTable[tonumber(j)], false, false)
		guiGridListSetItemData(ownList, row, ownColumn, hornsTable[tonumber(j)])
	end
end
)

soundTimer = {}
killOtherTimer = {}
local screenSizex, screenSizey = guiGetScreenSize()
local guix = screenSizex * 0.1
local guiy = screenSizex * 0.1
local globalscale = 1
local globalalpha = 1
icon = {}

function createSoundForCar(car, horn)
	if isElement(icon[car]) then destroyElement(icon[car]) end
	if isTimer(soundTimer[car]) then killTimer(soundTimer[car]) end
	if isTimer(killOtherTimer[car]) then killTimer(killOtherTimer[car]) end
	icon[car] = guiCreateStaticImage(0, 0, guix, guiy, "horns/icon.png", false )
	guiSetVisible(icon[car], false)
	local x,y,z = getElementPosition(car)
	local sound = playSound3D("horns/files/"..horn..".mp3", x, y, z, false)
	setSoundMaxDistance(sound, 50)
	local length = getSoundLength(sound)
	length = length * 1000
	soundTimer[car] = setTimer(function(sound, car)
		if not isElement(sound) or not isElement(car) then return end
		local rx,ry,rz = getElementPosition(car)
		setElementPosition(sound, rx, ry, rz)
		
		
		local playerx, playery, playerz = getElementPosition( getPedOccupiedVehicle(localPlayer) )
		cp_x, cp_y, cp_z = getElementPosition( car)
		local dist = getDistanceBetweenPoints3D ( cp_x, cp_y, cp_z, playerx, playery, playerz )
		if dist and dist < 40 and ( isLineOfSightClear(cp_x, cp_y, cp_z+1.2, playerx, playery, playerz, true, false, false, false )) then
			local screenX, screenY = getScreenFromWorldPosition ( cp_x, cp_y, cp_z+1.2 )
			local scaled = screenSizex * (1/(2*(dist+5))) *.85
			local relx, rely = scaled * globalscale, scaled * globalscale
			
			guiSetAlpha(icon[car], globalalpha)
			guiSetSize(icon[car], relx, rely, false)
			if(screenX and screenY) then
				guiSetPosition(icon[car], screenX, screenY, false)
				guiSetVisible(icon[car], true)
			else
				guiSetVisible(icon[car], false)
			end
		else
		 guiSetVisible(icon[car], false)
		end
		
		
		
	end, 50, 0, sound,car)
	
	killOtherTimer[car] = setTimer(function(theTimer, car) if isTimer(theTimer) then killTimer(theTimer) if isElement(icon[car]) then destroyElement(icon[car]) end end  end, length, 50, soundTimer[car], car)
end

addEvent("onPlayerUsingHorn", true)
addEventHandler("onPlayerUsingHorn", root,
function(horn, car)
	if (getElementData(source, "state") == "alive") and (getElementData(localPlayer, "state") == "alive") and (soundsOn == true) and (getElementData(localPlayer, "dim") == getElementData(source, "dim")) then
		local x,y,z = getElementPosition(getPedOccupiedVehicle(localPlayer))
		local rx, ry, rz = getElementPosition(car)
		if getDistanceBetweenPoints3D(x,y,z,rx,ry,rz) < 40 then
			createSoundForCar(car, horn)
		end	
	end	
end
)

soundsOn = true

